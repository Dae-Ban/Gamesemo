<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.demo.mapper.GameDataMapper">
	<insert id="insertSteamApi" parameterType="list">
		INSERT ALL
		<foreach collection="list" item="app">
			INTO game (g_num, g_title,
			n_title, steam_appid)
			VALUES (#{app.gNum}, #{app.gTitle},
			#{app.nTitle}, #{app.steamAppid})
		</foreach>
		SELECT * FROM dual
	</insert>
	<select id="selectAllAppIds" resultType="long">
		SELECT steam_appid FROM
		game
	</select>
	<select id="getGNum" parameterType="String" resultType="int">
		SELECT
		g_num FROM game WHERE n_title=#{nTitle}
	</select>
	
	<insert id="margeSteamDC">
		MERGE INTO game g
		USING (SELECT title, n_title, thumb
		FROM (
		SELECT title, n_title, thumb,
		ROW_NUMBER() OVER (PARTITION BY n_title ORDER BY title) AS rn
		FROM steam_dc
		)
		WHERE rn = 1) s
		ON (g.n_title = s.n_title)
		WHEN MATCHED THEN
		UPDATE SET
		g.thumb=s.thumb
		WHEN NOT MATCHED THEN
		INSERT (g_num, g_title, n_title,
		thumb)
		VALUES (seq_game.nextval, s.title, s.n_title, s.thumb)
	</insert>
	
	<insert id="margeSteamNew">
		MERGE INTO game g
		USING (SELECT title, n_title, thumb
		FROM (
		SELECT title, n_title, thumb,
		ROW_NUMBER() OVER (PARTITION BY n_title ORDER BY title) AS rn
		FROM steam_new
		)
		WHERE rn = 1) s
		ON (g.n_title = s.n_title)
		WHEN MATCHED THEN
		UPDATE SET
		g.thumb=s.thumb
		WHEN NOT MATCHED THEN
		INSERT (g_num, g_title, n_title,
		thumb)
		VALUES (seq_game.nextval, s.title, s.n_title, s.thumb)
	</insert>
	
	<insert id="margeDirectNew">
		MERGE INTO game g
		USING (SELECT title, n_title, thumb
		FROM (
		SELECT title, n_title, thumb,
		ROW_NUMBER() OVER (PARTITION BY n_title ORDER BY title) AS rn
		FROM direct_new
		)
		WHERE rn = 1) s
		ON (g.n_title = s.n_title)
		WHEN MATCHED THEN
		UPDATE SET
		g.thumb=s.thumb
		WHEN NOT MATCHED THEN
		INSERT (g_num, g_title, n_title,
		thumb)
		VALUES (seq_game.nextval, s.title, s.n_title, s.thumb)
	</insert>

</mapper>