<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.demo.mapper.ReportMapper">

  <!-- ‚úÖ Ïã†Í≥† Î™©Î°ù (ÌéòÏù¥Ïßï) -->
<select id="getPagedReportList" resultMap="reportResultMap">
  SELECT * FROM (
    SELECT inner_query.*, ROWNUM rn
    FROM (
      SELECT 
        R.RP_NUM,
        R.ID,
        R.RP_REASON,
        R.RP_DATE,
        R.RP_TABLE,
        R.BOARD_NUM,
        R.RP_STATUS,
        CASE 
          WHEN LOWER(R.RP_TABLE) = 'community_board' THEN C.CB_TITLE
          WHEN LOWER(R.RP_TABLE) = 'review_board' THEN V.RB_TITLE
          ELSE 'Ïïå Ïàò ÏóÜÏùå'
        END AS POSTTITLE
      FROM REPORT R
      LEFT JOIN COMMUNITY_BOARD C 
        ON LOWER(R.RP_TABLE) = 'community_board' AND R.BOARD_NUM = C.CB_NUM
      LEFT JOIN REVIEW_BOARD V 
        ON LOWER(R.RP_TABLE) = 'review_board' AND R.BOARD_NUM = V.RB_NUM
      <where>
        <if test="type != null and keyword != null and keyword != ''">
          <choose>
            <when test="type == 'reporter'">
              LOWER(R.ID) LIKE '%' || LOWER(#{keyword}) || '%'
            </when>
            <when test="type == 'table'">
              LOWER(R.RP_TABLE) LIKE '%' || LOWER(#{keyword}) || '%'
            </when>
            <when test="type == 'status'">
              R.RP_STATUS = #{keyword}
            </when>
          </choose>
        </if>
      </where>
      ORDER BY R.RP_DATE DESC
    ) inner_query
    WHERE ROWNUM &lt;= #{endRow}
  )
  WHERE rn &gt;= #{startRow}
</select>
  <!-- ‚úÖ Ïã†Í≥† Ï¥ù Í∞úÏàò -->
 <select id="getTotalReportCount" resultType="int">
  SELECT COUNT(*)
  FROM REPORT R
  <where>
    <if test="type != null and keyword != null and keyword != ''">
      <choose>
        <when test="type == 'reporter'">
          LOWER(R.ID) LIKE '%' || LOWER(#{keyword}) || '%'
        </when>
        <when test="type == 'table'">
          LOWER(R.RP_TABLE) LIKE '%' || LOWER(#{keyword}) || '%'
        </when>
        <when test="type == 'status'">
          R.RP_STATUS = #{keyword}
        </when>
      </choose>
    </if>
  </where>
</select>

  <!-- ‚úÖ Ïã†Í≥† ÏÉÅÏÑ∏ Ï°∞Ìöå -->
  <select id="selectReportById" resultType="com.example.demo.model.ReportDTO">
    SELECT * FROM REPORT WHERE RP_NUM = #{rpNum}
  </select>

 <!-- ‚úÖ communityBoardÏö© resultMap -->
<resultMap id="communityResultMap" type="com.example.demo.model.Community">
  <id     property="cb_num"      column="CB_NUM"/>
  <result property="id"          column="ID"/>
  <result property="cb_title"    column="CB_TITLE"/>
  <result property="cb_content"  column="CB_CONTENT"/>
  <result property="cb_readcount" column="CB_READCOUNT"/>
  <result property="cb_date"     column="CB_DATE"/>
  <result property="cb_state"    column="CB_STATE"/>
</resultMap>

<!-- ‚úÖ communityBoard Í≤åÏãúÍ∏Ä ÏÉÅÏÑ∏ Ï°∞Ìöå -->
<select id="selectCommunityPost" resultMap="communityResultMap">
  SELECT * FROM COMMUNITY_BOARD WHERE CB_NUM = #{boardNum}
</select>

  <!-- ‚úÖ Î¶¨Î∑∞Í≤åÏãúÌåê Í≤åÏãúÍ∏Ä ÏÉÅÏÑ∏ Ï°∞Ìöå (üõ† resultMap ÏÇ¨Ïö©!) -->
  <resultMap id="reviewResultMap" type="com.example.demo.model.Review">
    <id property="rb_num" column="RB_NUM"/>
    <result property="id" column="ID"/>
    <result property="rb_title" column="RB_TITLE"/>
    <result property="rb_readcount" column="RB_READCOUNT"/>
    <result property="rb_date" column="RB_DATE"/>
    <result property="rb_state" column="RB_STATE"/>
    <result property="rb_like" column="RB_LIKE"/>
    <result property="rb_content" column="RB_CONTENT"/>
  </resultMap>

  <select id="selectReviewPost" resultMap="reviewResultMap">
    SELECT * FROM REVIEW_BOARD WHERE RB_NUM = #{boardNum}
  </select>

  <!-- ‚úÖ Ïã†Í≥† Ï≤òÎ¶¨ ÏÉÅÌÉú Î≥ÄÍ≤Ω -->
  <update id="updateReportStatus">
    UPDATE REPORT SET RP_STATUS = 'RESOLVED' WHERE RP_NUM = #{rpNum}
  </update>

  <!-- ‚úÖ ÏûêÏú†Í≤åÏãúÌåê Î∏îÎùºÏù∏Îìú Ï≤òÎ¶¨ -->
  <update id="blindCommunityPost">
    UPDATE COMMUNITY_BOARD SET CB_STATE = 1 WHERE CB_NUM = #{boardNum}
  </update>
  
  <!-- ÏûêÏú†Í≤åÏãúÌåê Î∏îÎùºÏù∏Îìú Ìï¥Ï†ú -->
  <update id="unblindCommunityPost">
  UPDATE COMMUNITY_BOARD SET CB_STATE = 0 WHERE CB_NUM = #{boardNum}
  </update>

  <!-- ‚úÖ Î¶¨Î∑∞Í≤åÏãúÌåê Î∏îÎùºÏù∏Îìú Ï≤òÎ¶¨ -->
  <update id="blindReviewPost">
    UPDATE REVIEW_BOARD SET RB_STATE = 1 WHERE RB_NUM = #{boardNum}
  </update>
  
  <!-- Î¶¨Î∑∞Í≤åÏãúÌåê Î∏îÎùºÏù∏Îìú Ìï¥Ï†ú -->
  <update id="unblindReviewPost">
  UPDATE REVIEW_BOARD SET RB_STATE = 0 WHERE RB_NUM = #{boardNum}
  </update>

  <!-- ‚úÖ Ïã†Í≥† ÏÉÅÌÉú Î≥µÏõê (PENDING) -->
  <update id="updateReportStatusToPending">
    UPDATE REPORT SET RP_STATUS = 'PENDING' WHERE RP_NUM = #{rpNum}
  </update>
  
  

  <!-- ‚úÖ Ïã†Í≥† Î™©Î°ù Í≤∞Í≥º Îß§Ìïë -->
  <resultMap id="reportResultMap" type="com.example.demo.model.ReportDTO">
    <id     property="rpNum"      column="RP_NUM" />
    <result property="id"         column="ID" />
    <result property="rpReason"   column="RP_REASON" />
    <result property="rpDate"     column="RP_DATE" />
    <result property="rpTable"    column="RP_TABLE" />
    <result property="boardNum"   column="BOARD_NUM" />
    <result property="rpStatus"   column="RP_STATUS" />
    <result property="postTitle"  column="POSTTITLE" />
  </resultMap>

</mapper>