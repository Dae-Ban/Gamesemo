<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.demo.mapper.ReportMapper">

  <!-- 페이징 신고 목록 조회 -->
<select id="selectPagedReportList" resultMap="reportResultMap">
  SELECT * FROM (
    SELECT inner_query.*, ROWNUM rn
    FROM (
      SELECT 
        R.RP_NUM,
        R.ID,
        R.RP_REASON,
        R.RP_DATE,
        R.RP_TABLE,
        R.BOARD_NUM,
        R.RP_STATUS,
        CASE 
          WHEN R.RP_TABLE = 'community_board' THEN C.CB_TITLE
          WHEN R.RP_TABLE = 'review_board' THEN V.RB_TITLE
          ELSE '알 수 없음'
        END AS POSTTITLE
      FROM REPORT R
      LEFT JOIN COMMUNITY_BOARD C ON R.RP_TABLE = 'community_board' AND R.BOARD_NUM = C.CB_NUM
      LEFT JOIN REVIEW_BOARD V ON R.RP_TABLE = 'review_board' AND R.BOARD_NUM = V.RB_NUM
      ORDER BY R.RP_DATE DESC
    ) inner_query
    WHERE ROWNUM &lt;= #{endRow}
  )
  WHERE rn &gt;= #{startRow}
</select>

  <!-- 신고 총 개수 -->
  <select id="countReportTotal" resultType="int">
    SELECT COUNT(*) FROM REPORT
  </select>

  <!-- 신고 상세 조회 -->
  <select id="selectReportById" resultType="com.example.demo.model.ReportDTO">
    SELECT * FROM REPORT WHERE RP_NUM = #{rpNum}
  </select>

  <!-- 자유게시판 게시글 상세 -->
  <select id="selectCommunityPost" resultType="com.example.demo.model.Community">
    SELECT * FROM COMMUNITY_BOARD WHERE CB_NUM = #{boardNum}
  </select>

  <!-- 리뷰게시판 게시글 상세 -->
  <select id="selectReviewPost" resultType="com.example.demo.model.Review">
    SELECT * FROM REVIEW_BOARD WHERE RB_NUM = #{boardNum}
  </select>

  <!-- 신고 처리 상태 변경 -->
  <update id="updateReportStatus">
    UPDATE REPORT SET RP_STATUS = 'RESOLVED' WHERE RP_NUM = #{rpNum}
  </update>

  <!-- 자유게시판 블라인드 -->
  <update id="blindCommunityPost">
    UPDATE COMMUNITY_BOARD SET CB_STATE = 1 WHERE CB_NUM = #{boardNum}
  </update>

  <!-- 리뷰게시판 블라인드 -->
  <update id="blindReviewPost">
    UPDATE REVIEW_BOARD SET RB_STATE = 1 WHERE RB_NUM = #{boardNum}
  </update>

  <!-- 상태변환 처리 -->
  <update id="updateReportStatusToPending">
  UPDATE REPORT SET RP_STATUS = 'PENDING' WHERE RP_NUM = #{rpNum}
</update>

<resultMap id="reportResultMap" type="com.example.demo.model.ReportDTO">
  <id     property="rpNum"      column="RP_NUM" />
  <result property="id"         column="ID" />
  <result property="rpReason"   column="RP_REASON" />
  <result property="rpDate"     column="RP_DATE" />
  <result property="rpTable"    column="RP_TABLE" />
  <result property="boardNum"   column="BOARD_NUM" />
  <result property="rpStatus"   column="RP_STATUS" />
  <result property="postTitle"  column="POSTTITLE" />
</resultMap>
</mapper>