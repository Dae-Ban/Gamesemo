<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.demo.mapper.AdminAnnoMapper">

  <!-- 목록 조회: 페이징 + 검색 -->
<select id="selectAnnoList" resultType="com.example.demo.model.AdminAnno">
  SELECT * FROM (
    SELECT A.*, ROWNUM rn
    FROM (
      SELECT an_num, an_title, an_content, an_date, an_state
      FROM ANNOUNCEMENT
      <where>
        <if test="type == 'title' and keyword != null">
          an_title LIKE '%' || #{keyword} || '%'
        </if>
        <if test="type == 'content' and keyword != null">
          an_content LIKE '%' || #{keyword} || '%'
        </if>
        <if test="type == 'state' and keyword != null">
          <choose>
            <when test="keyword == '공개'">
              an_state = 1
            </when>
            <when test="keyword == '비공개'">
              an_state = 0
            </when>
            <otherwise>
              1 = 1
            </otherwise>
          </choose>
        </if>
      </where>
      ORDER BY an_num DESC
    ) A
    WHERE ROWNUM &lt;= #{endRow}
  )
  WHERE rn &gt;= #{startRow}
</select>

  <!-- 총 개수 (검색 포함) -->
 <select id="getTotal" resultType="int">
  SELECT COUNT(*)
  FROM ANNOUNCEMENT
  <where>
    <if test="type == 'title' and keyword != null">
      an_title LIKE '%' || #{keyword} || '%'
    </if>
    <if test="type == 'content' and keyword != null">
      an_content LIKE '%' || #{keyword} || '%'
    </if>
    <if test="type == 'state' and keyword != null">
      <choose>
        <when test="keyword == '공개'">
          an_state = 1
        </when>
        <when test="keyword == '비공개'">
          an_state = 0
        </when>
        <otherwise>
          1 = 1  <!-- 조건 무력화 -->
        </otherwise>
      </choose>
    </if>
  </where>
</select>

  <!-- 상세 조회 -->
  <select id="getAnnoDetail" resultType="com.example.demo.model.AdminAnno">
    SELECT an_num, an_title, an_content, an_date, an_state
    FROM ANNOUNCEMENT
    WHERE an_num = #{anNum}
  </select>
  
  <!-- 글작성 -->
  <insert id="insertAnno" parameterType="com.example.demo.model.AdminAnno">
  	INSERT INTO ANNOUNCEMENT (an_num,an_title,an_content,an_date,an_state)
  	values(seq_ANNOUNCEMENT.nextval,#{anTitle},#{anContent},sysdate,#{anState})
  
  </insert>
  
  <!-- 글수정 -->
  <update id="updateAnno" parameterType="com.example.demo.model.AdminAnno">
  	update ANNOUNCEMENT set an_title=#{anTitle},an_content=#{anContent},
  	an_state=#{anState} where an_num=#{anNum}
  </update>

  <!-- 글삭제 -->
  <delete id="deleteAnno">
  	delete from ANNOUNCEMENT where an_num=#{anNum}
  </delete>

</mapper>